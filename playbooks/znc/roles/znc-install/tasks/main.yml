---
- name: install pexpect pip module
  pip:
    name: pexpect
  become: true
- name: check if data dir exists
  stat:
    path: "{{ znc_data_dir }}"
  register: file
  become: true
- name: "create znc directories in {{ znc_root_dir }}"
  file:
    path: "{{ item }}"
    state: directory
    force: no
    owner: "{{ znc_uuid }}"
    group: "{{ znc_guid }}"
    recurse: yes
  with_items:
  - "{{ znc_data_dir }}"
  become: true
- name: "pull znc:{{ znc_version }} image"
  docker_image:
    name: znc
    tag: "{{ znc_version }}"
    source: pull
  become: true
- name: "run initial configuration if {{ znc_data_dir }} didn't exist before"
  expect:
     command: "docker run -it --rm -v {{ znc_data_dir }}:/znc-data znc --makeconf"
     responses:
       Question:
         - "(.*)Listen on port(.*): {{ znc_port }}"
         - "(.*)Listen using SSL(.*): no"
         - "(.*)Listen using both IPv4 and IPv6(.*): no"
         - "(.*)Username (.*): {{ znc_username }}"
         - "(.*)Enter password: {{ znc_password }}"
         - "(.*)Confirm password: {{ znc_password }}"
         - "(.*)Nick(.*): {{ irc_nick }}"
         - "(.*)Alternate nick(.*): {{ irc_nick }}_"
         - "(.*)Ident(.*): {{ znc_username }}"
         - "(.*)Real name(.*): {{ real_name }}"
         - "(.*)Bind host(.*): "
         - "(.*)Set up a network?(.*): no"
         - "(.*)Launch ZNC now?(.*): no"
  when: file.stat.exists == False
  become: true
- name: run znc container
  docker_container:
    name: znc
    image: "znc:{{ znc_version }}"
    restart_policy: unless-stopped
    volumes: "{{ znc_volumes }}"
    ports: "{{ znc_ports }}"
  become: true
